/*Di BaoSummer 2012The JS file for Search Annotations side tab*/var annotations_fn = annotations_fn || {};jQuery.fn.search_anno = function(){		/*----set-ups----*/	var menuIndex4=0;	var parentElement4='.content_0';//for ANNO	var ANNO_abort;//for ANNO, to abort the current ajax call		var $handler = $("#ANNO_display").find('p');	$handler.append("[]");		for(var i=1; i<=10; i++)	$("#ANNO_extend"+i).hide();		$("#search_anno").attr("disabled","disabled");//disable the search button	$("#cancel_anno").attr("disabled", "disabled");//disable the cancel button	/*----end----*/		/*for section1, the parameters*/	//the submit button for section3	$("#ANNO_addBtn").livequery('click', function(){        menuIndex4++;        childElement4='.content_'+menuIndex4;		var param = $('#ANNO_menu'+parentElement4).find('select').val();		var val = $('#ANNO_menu'+parentElement4).find('input[type="text"]').val();				if(param && val){			var string = $handler.text();			string = string.substring(0, string.length-1);			if($handler.text() == '[]'){				string += param+' = '+val + ']';			}else{				string += ' AND ' +param+' = '+val + ']';			}			$handler.text(string);					var clone=$('#ANNO_menu'+parentElement4).clone(true);			clone.attr('class','content_'+menuIndex4);			clone.insertAfter($('#ANNO_menu'+parentElement4));			$(parentElement4+' #ANNO_addBtn').attr("disabled","disabled");			$("#search_anno").removeAttr("disabled");//active the search button						$(parentElement4+' #ANNO_parameter_select').attr("disabled","disabled");			$(parentElement4+' #ANNO_value_input').attr("disabled","disabled");//disable the first row of selectors			$(childElement4+' #ANNO_value_input').val('');							parentElement4 = childElement4;						//hide the explanations			for(var i=1; i<=10; i++)	$("#ANNO_extend"+i).hide();		}else{			menuIndex4--;			alert("Invalid Parameters!");		}	});		$("#ANNO_minBtn").livequery('click', function(){		var $curr_line = $(this).parent().parent();		var front_part = $curr_line.find("select").val();		var follow_part = $curr_line.find("input").val();		if(!$curr_line.find("#ANNO_addBtn").attr("disabled")){			;		}else{			var str_to_remove = front_part + " = " + follow_part + " AND ";			//alert(str_to_remove);			var original_str = $handler.text();			var the_offset = original_str.indexOf(str_to_remove);			if(the_offset == -1){				//alert(str_to_remove.slice(0, -5)+ "hhh");				the_offset = original_str.indexOf(" AND "+str_to_remove.slice(0, -5));				if(the_offset == -1){					//alert(str_to_remove.slice(0, -5)+ "ddd");					the_offset = original_str.indexOf(str_to_remove.slice(0, -5));					str_to_remove = str_to_remove.slice(0, -5);				}			}			if(the_offset >= 0){				//alert(the_offset);				var new_str = original_str.substring(0, the_offset) + original_str.substring(the_offset+str_to_remove.length, original_str.length);				//alert(new_str);				$handler.text(new_str);				$curr_line.hide();			}		}	});	/*---------end----------*/		//trigger the explanation for the parameter selector	$("#ANNO_parameter_select").bind('change', function(){		var param = $(this).find("option:selected").val();		//alert(condi);		for(var i=1; i<=10; i++)	$("#ANNO_extend"+i).hide();				switch(param){			case "first_name":				$("#ANNO_extend1").show(500);				break;			case "last_name":				$("#ANNO_extend2").show(500);				break;			case "username":				$("#ANNO_extend3").show(500);				break;			case "user_id":				$("#ANNO_extend4").show(500);				break;			case "group_name":				$("#ANNO_extend5").show(500);				break;			case "type":				$("#ANNO_extend6").show(500);				break;			case "target_type":				$("#ANNO_extend7").show(500);				break;			case "keyword":				$("#ANNO_extend8").show(500);				break;			case "ra": case "dec": case "raFrom": case "raTo": case "decFrom": case "decTo":				$("#ANNO_extend9").show(500);				break;			case "limit":				$("#ANNO_extend10").show(500);				break;			default:				for(var i=1; i<=10; i++)	$("#ANNO_extend"+i).hide();				break;		}	});	/*---------end----------*/		//for the search button	$("#search_anno").bind('click', function(){		$("#search_anno").attr("disabled", "disabled");		$("#cancel_anno").removeAttr("disabled");		$("#reset_anno").attr("disabled", "disabled");				var cal = $handler.text();//assemble the URL GET method		cal = cal.substring(1, cal.length-1);		cal = cal.replace(/ AND /g, '&');		cal = cal.replace(/ = /g, '=');		/*--------use preference--------*/		//var preference = '';		if($("#ANNO_pref").attr("checked")){			//preference = "get user's AnnoDB preference from REST API";			//alert(preference);			user_id = getUserId();			//alert(user_id);			if(user_id > -1)	cal += '&usePref=true&active_user=' + user_id;		}		/*----end----*/		var formatted_time = gFUNCS.create_time();		$("#results_content #tab1 p:last").hide();		$("#results_content #tab1").append('<div></div>');		$("#results_content #tab1 div:last").append('<label class="search_annotation_label"><b>Search Annotations - request on AnnoDB <br/>(' + formatted_time + ')</b></label>');		$("#results_content #tab1 div:last").append('<p>Processing...</p><br/><br/><a href="#" class ="toggle">Hide/Show</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" class="remove">Remove from the list</a>');		$("#results_content #tab1 div:last").append('&nbsp;&nbsp;&nbsp;&nbsp;<a href="#" class="overlay">Create overlay</a><hr/>');		$("#results_content #tab1 a:last").data("source", "ANNO");		$("#results_content #tab1 a:last").data("query", cal);				ANNO_abort = $.ajax({			type: "GET",			url: secureRESTbase + "annotation/search",			data: cal,			dataType: "json",			beforeSend: setAuthHeaders,			success: function(json){				if(json.length==0){					$("#results_content #tab1 div:last").find('p').html('No rows returned...');					$("#results_content #tab1 div:last").find('a[class=overlay]').remove();				}else{									annotations_fn.displayResult(json);				}			},			error: function(){				$("#results_content #tab1 div:last").find('p').html('Internal Server Error...');				$("#results_content #tab1 div:last").find('a[class=overlay]').remove();			},			crossDomain: true		});		//reset search_annotations tab		$("#search_anno").removeAttr("disabled");		$("#cancel_anno").attr("disabled", "disabled");		$("#reset_anno").removeAttr("disabled");		//alert("here");		if($('#object_tab').hasClass('open')){			$('#object_handle').trigger("click");		}		if(!$('#results').hasClass('open')){			$('#results_handle').trigger("click");		}	});	/*---------end----------*/		//for the cancel button	$("#cancel_anno").bind('click', function(){		$("#results_content #tab1 div:last").find('p').html('Cancelled...');		$("#results_content #tab1 div:last").find('a[class=overlay]').remove();				$("#search_anno").removeAttr("disabled");		$("#cancel_anno").attr("disabled", "disabled");		$("#reset_anno").removeAttr("disabled");		ANNO_abort.abort();	});	/*---------end----------*/		//for the reset buttion	$("#reset_anno").bind('click', function(){		//reset section1, the parameters		parentElement4='.content_0';		var currElement = '.content_'+menuIndex4;		while(menuIndex4){			$('#ANNO_menu'+currElement).remove();						menuIndex4--;			currElement = '.content_'+menuIndex4;		}		if($('#ANNO_menu.content_0').length == 0){			//alert("impossible!!!");		}else{			$('#ANNO_menu.content_0').show();		}		$(currElement+' #ANNO_addBtn').removeAttr("disabled");		$(currElement+' #ANNO_parameter_select').removeAttr("disabled");		$(currElement+' #ANNO_value_input').removeAttr("disabled");		$(currElement+' #ANNO_parameter_select').val('');		$(currElement+' #ANNO_value_input').val('');		for(var i=1; i<=10; i++)	$("#ANNO_extend"+i).hide();				//reset section2, the display		$handler.text("[]");				//reset search button		$("#search_anno").attr("disabled", "disabled");		$("#cancel_anno").attr("disabled", "disabled");//disable the cancel button				$("#ANNO_pref").removeAttr("checked");	});	/*-----end------*/		annotations_fn.setupAnnotationTables = function() {		//Get user annotations		$.ajax({type: "GET",			url: "./lib/db/local/queryASTRO.php",			data: { get_anno_for_user:1, user_id:getUserId() },			dataType: "json"		}).done(function(json_msg) {			var annotations = json_msg["annotations"];			var data_table = {"bPaginate": true, "bLengthChange": true, "bFilter": false, "aaSorting" : [], "aaData":[]};			if(annotations.length > 0) {				data_table.aoColumns = [{"sTitle": "Title", "bSortable": true}, {"sTitle": "Value", "bSortable": true}, {"sTitle": "tsCreated", "bSortable": true}, {"sTitle":"", "bSortable":false}];			}			for(var i = 0; i < annotations.length; i++) {				var title_span = "<span data-id=" + annotations[i].id + ">" + annotations[i].title + "</span>";				var date_string_arr = annotations[i].ts_created.split("-");				date_string = date_string_arr[0] + "-" + date_string_arr[1].toUpperCase() + "-" + date_string_arr[2];				data_table.aaData.push([title_span, annotations[i].value, date_string, "<a href='#' class='anno_details'><span class='ui-icon ui-icon-info'/></a>"]);			}			if($("#annotations_tab2 div:first table").hasClass("dataTable")) {				$("#annotations_tab2 div:first table").dataTable().fnDestroy();			}			$("#annotations_tab2 div:first table").dataTable(data_table).width("100%");			$("#annotations_tab2 div:first table").on('draw.dt', function() {				$("#annotations_tab2 a.anno_details").unbind("click");				$("#annotations_tab2 a.anno_details").click(function(){					var annoId = $(this).parent().parent().children().first().children().first().data("id");					FUNCS4.showAnnoDetails(annoId);				});			});			$("#annotations_tab2 a.anno_details").click(function(){				var annoId = $(this).parent().parent().children().first().children().first().data("id");				FUNCS4.showAnnoDetails(annoId);			});		}).error(function(jqXHR, textStatus, errorThrown) {			console.log("Error:  " + errorThrown);			console.log(textStatus);			console.log(jqXHR);		});				//Get group annotations		$.ajax({type: "GET",			url: "./lib/db/local/queryASTRO.php",			data: { get_anno_for_group:1, user_id:getUserId() },			dataType: "json"		}).done(function(json_msg) {			var annotations = json_msg["annotations"];			var data_table = {"bPaginate": true, "bLengthChange": true, "bFilter": false, "aaSorting" : [], "aaData":[]};			if(annotations.length > 0) {				data_table.aoColumns = [{"sTitle": "Title", "bSortable": true}, {"sTitle":"Group", "bSortable":true}, {"sTitle": "Value", "bSortable": true}, {"sTitle": "tsCreated", "bSortable": true}, {"sTitle": "", "bSortable": false}];			}			for(var i = 0; i < annotations.length; i++) {				var title_span = "<span data-id=" + annotations[i].id + ">" + annotations[i].title + "</span>";				var date_string_arr = annotations[i].ts_created.split("-");				date_string = date_string_arr[0] + "-" + date_string_arr[1].toUpperCase() + "-" + date_string_arr[2];				data_table.aaData.push([title_span, annotations[i].group_name, annotations[i].value, date_string, "<a href='#' class='anno_details'><span class='ui-icon ui-icon-info'/></a>"]);			}			if($("#annotations_tab3 div:first table").hasClass("dataTable")) {				$("#annotations_tab3 div:first table").dataTable().fnDestroy();			}			$("#annotations_tab3 div:first table").dataTable(data_table).width("100%");			$("#annotations_tab3 div:first table").on('draw.dt', function() {				$("#annotations_tab3 a.anno_details").unbind("click");				$("#annotations_tab3 a.anno_details").click(function(){					var annoId = $(this).parent().parent().children().first().children().first().data("id");					FUNCS4.showAnnoDetails(annoId);				});			});			$("#annotations_tab3 a.anno_details").click(function(){				var annoId = $(this).parent().parent().children().first().children().first().data("id");				FUNCS4.showAnnoDetails(annoId);			});		}).error(function(jqXHR, textStatus, errorThrown) {			console.log("Error:  " + errorThrown);			console.log(textStatus);			console.log(jqXHR);		});	}        annotations_fn.displayResult = function(json) {        /*----------formatting json-----------*/        var json_msg = '{ "aoColumns": [ ';        json_msg += '{"sTitle": "tsCreated"}, ';        json_msg += '{"sTitle": "annoId"}, ';        json_msg += '{"sTitle": "annoTitle"}, ';        json_msg += '{"sTitle": "annoValue"}, ';        json_msg += '{"sTitle": "author"}, ';        json_msg += '{"sTitle": "group"}, ';        json_msg += '{"sTitle": "targetType"}, ';        json_msg += '{"sTitle": "ra"}, ';        json_msg += '{"sTitle": "dec"}, ';        json_msg += '{"sTitle": "details"}';        json_msg += '], "aaData": [ ';        for(i=0; i<json.length; i++){            var formatted_time1 = gFUNCS.convert_time(json[i]["ts_created"]);            json_msg += '["' + formatted_time1 + '", ';            json_msg += '"' + json[i]["anno_id"] + '", ';            json_msg += '"' + json[i]["anno_title"] + '", ';            var anno_val = json[i]["anno_value"];            var truncated_val = anno_val;            if(anno_val.length > 128) {                truncated_val = anno_val.substring(0,128) + "...";            }            if(json[i]["anno_type_id"] == 4) {                var new_anno_val = '<a href=\'' + anno_val + '\' target=\'_blank\'>' + truncated_val + '</a>';            } else {                var new_anno_val = truncated_val.replace(/\&amp;/g, '&');                new_anno_val = new_anno_val.replace(/\&lt;/g, '<');                new_anno_val = new_anno_val.replace(/\&gt;/g, '>');            }            json_msg += '"' + new_anno_val + '", ';            json_msg += '"' + json[i]["user.fname"] +" "+ json[i]["user.lname"] + '", ';            json_msg += '"' + json[i]["user.group"] + '", ';            json_msg += '"' + json[i]["target_type"] + '", ';                        //for the object on which annotation attached            if(json[i]["target_type"] == "object") {                json_msg += '"<a href=\'#\' class=\'jump\' name=\'ra\'>' + json[i]["object.RA"] + '</a>", ';                json_msg += '"<a href=\'#\' class=\'jump\' name=\'dec\'>' + json[i]["object.Dec"] + '</a>", ';            } else if(json[i]["target_type"] == "area/point") {                json_msg += '"<a href=\'#\' class=\'jump\' name=\'ra\'>' + json[i]["area_point.RA_bl"] + '</a>", ';                json_msg += '"<a href=\'#\' class=\'jump\' name=\'dec\'>' + json[i]["area_point.Dec_bl"] + '</a>", ';            } else {                json_msg += '"N/A", "N/A", ';            }            json_msg += '"<a href=\'#\' class=\'more\' name=\'anno\'>more</a>"], ';        }        json_msg = json_msg.substring(0, json_msg.length-2);        json_msg += ' ] }';        /*----end----*/                json_msg = jQuery.parseJSON(json_msg);        var the_id = "ANNO_table" + restab_base.anno_base;        restab_base.anno_base++;        $("#results_content #tab1 div:last").find('p').html('<table cellpadding="0" cellspacing="0" border="0" class="display" id="'+the_id+'"></table>');        var oTable = $("#results_content #tab1 div:last #"+the_id).dataTable(json_msg);        var oTableTools = new TableTools(oTable, {            "sSwfPath": "./lib/DataTables-1.9.1/extras/TableTools/media/swf/copy_csv_xls_pdf.swf"        });	        $('#'+the_id+'_wrapper').before(oTableTools.dom.container);    }    	annotations_fn.setupAnnotationTables();};