// Generated by CoffeeScript 1.3.3
(function() {
  var Data, Image,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Data = require('./fits.data');

  Image = (function(_super) {

    __extends(Image, _super);

    function Image(view, header) {
      var bitpix, i, naxis, _i,
        _this = this;
      Image.__super__.constructor.apply(this, arguments);
      naxis = header["NAXIS"];
      bitpix = header["BITPIX"];
      this.naxis = [];
      for (i = _i = 1; 1 <= naxis ? _i <= naxis : _i >= naxis; i = 1 <= naxis ? ++_i : --_i) {
        this.naxis.push(header["NAXIS" + i]);
      }
      this.rowByteSize = header["NAXIS1"] * Math.abs(bitpix) / 8;
      this.rowsRead = 0;
      this.min = header["DATAMIN"] != null ? header["DATAMIN"] : void 0;
      this.max = header["DATAMAX"] != null ? header["DATAMAX"] : void 0;
      this.length = this.naxis.reduce(function(a, b) {
        return a * b;
      }) * Math.abs(bitpix) / 8;
      this.data = void 0;
      this.frame = -1;
      switch (bitpix) {
        case 8:
          this.arrayType = Uint8Array;
          this.accessor = function() {
            return _this.view.getUint8();
          };
          break;
        case 16:
          this.arrayType = Int16Array;
          this.accessor = function() {
            return _this.view.getInt16();
          };
          break;
        case 32:
          this.arrayType = Int32Array;
          this.accessor = function() {
            return _this.view.getInt32();
          };
          break;
        case 64:
          this.arrayType = Int32Array;
          this.accessor = function() {
            var factor, highByte, lowByte, mod, value;
            console.warn("Something funky happens here when dealing with 64 bit integers.  Be wary!!!");
            highByte = Math.abs(_this.view.getInt32());
            lowByte = Math.abs(_this.view.getInt32());
            mod = highByte % 10;
            factor = mod ? -1 : 1;
            highByte -= mod;
            value = factor * ((highByte << 32) | lowByte);
            return value;
          };
          break;
        case -32:
          this.arrayType = Float32Array;
          this.accessor = function() {
            return _this.view.getFloat32();
          };
          break;
        case -64:
          this.arrayType = Float64Array;
          this.accessor = function() {
            return _this.view.getFloat64();
          };
          break;
        default:
          throw "FITS keyword BITPIX does not conform to one of the following set values [8, 16, 32, 64, -32, -64]";
      }
    }

    Image.prototype.initArray = function() {
      return this.data = new this.arrayType(this.naxis.reduce(function(a, b) {
        return a * b;
      }));
    };

    Image.prototype.getRow = function() {
      var i, rowLength, _i, _ref;
      this.current = this.begin + this.rowsRead * this.rowByteSize;
      rowLength = this.naxis[0];
      this.view.seek(this.current);
      for (i = _i = 0, _ref = rowLength - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        this.data[rowLength * this.rowsRead + i] = this.accessor();
      }
      return this.rowsRead += 1;
    };

    Image.prototype.getFrame = function() {
      var i, _i, _ref;
      if (this.data == null) {
        this.initArray();
      }
      for (i = _i = 0, _ref = this.naxis[1] - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        this.getRow();
      }
      this.frame += 1;
      return this.data;
    };

    Image.prototype.getFrameWebGL = function() {
      var i, j, rowLength, _i, _j, _ref, _ref1;
      this.data = new Float32Array(this.naxis.reduce(function(a, b) {
        return a * b;
      }));
      this.rowsRead = 0;
      rowLength = this.naxis[0];
      for (j = _i = 0, _ref = this.naxis[1] - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; j = 0 <= _ref ? ++_i : --_i) {
        this.current = this.begin + this.rowsRead * this.rowByteSize;
        this.view.seek(this.current);
        for (i = _j = 0, _ref1 = rowLength - 1; 0 <= _ref1 ? _j <= _ref1 : _j >= _ref1; i = 0 <= _ref1 ? ++_j : --_j) {
          this.data[rowLength * this.rowsRead + i] = this.accessor();
        }
        this.rowsRead += 1;
      }
      this.frame += 1;
      return this.data;
    };

    Image.prototype.getExtremes = function() {
      var i, index, max, min, value, _i, _j, _len, _ref, _ref1, _ref2, _ref3;
      if ((this.min != null) && (this.max != null)) {
        return [this.min, this.max];
      }
      _ref = this.data;
      for (index = _i = 0, _len = _ref.length; _i < _len; index = ++_i) {
        value = _ref[index];
        if (isNaN(value)) {
          continue;
        }
        _ref1 = [value, value], min = _ref1[0], max = _ref1[1];
        break;
      }
      for (i = _j = index, _ref2 = this.data.length - 1; index <= _ref2 ? _j <= _ref2 : _j >= _ref2; i = index <= _ref2 ? ++_j : --_j) {
        value = this.data[i];
        if (isNaN(value)) {
          continue;
        }
        if (value < min) {
          min = value;
        }
        if (value > max) {
          max = value;
        }
      }
      _ref3 = [min, max], this.min = _ref3[0], this.max = _ref3[1];
      return [this.min, this.max];
    };

    Image.prototype.getPixel = function(x, y) {
      return this.data[(this.frame * this.naxis[0] * this.naxis[1]) + y * this.naxis[0] + x];
    };

    Image.prototype.seek = function(frame) {
      if (frame == null) {
        frame = 0;
      }
      if (this.naxis.length === 2) {
        this.rowsRead = 0;
        return this.frame = -1;
      } else {
        this.rowsRead = this.naxis[1] * (frame + 1);
        return this.frame = this.naxis[1] / this.rowsRead - 1;
      }
    };

    return Image;

  })(Data);

  if (typeof module !== "undefined" && module !== null) {
    module.exports = Image;
  }

}).call(this);
